version: "3.9"

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NODE_ENV: development
    container_name: test-devops-app
    environment:
      NODE_ENV: development
      # ตั้งค่าให้ app ส่ง metrics ไปที่ Graphite/StatsD container
      STATSD_HOST: graphite
      STATSD_PORT: "8125"
    depends_on:
      - graphite
    # ถ้า index.js เปิด HTTP port ใด ๆ (เช่น 3000) ให้ map ออกมา
    ports:
      - "3000:3000"

  graphite:
    image: graphiteapp/graphite-statsd:latest
    container_name: graphite
    restart: unless-stopped
    ports:
      - "8080:80"        # Graphite Web UI http://localhost:8080
      - "8125:8125/udp"  # StatsD UDP
      - "8126:8126"      # StatsD admin (optional)
    # volumes สามารถเพิ่มทีหลังถ้าอยาก persist data
    # volumes:
    #   - graphite_data:/opt/graphite/storage

# volumes:
#   graphite_data:
