name: CI Pipeline

on:
  push:
    branches: [ develop, main ]
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  id-token: write
  security-events: write

env:
  REGION: asia-southeast1
  REPO_NAME: test-devops-images
  IMAGE_NAME: test-devops

jobs:
  ci:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # Checkout Source
      # ---------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------
      # Install & Cache Node deps
      # ---------------------------
      - name: Setup Node
        if: ${{ hashFiles('package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install Dependencies
        if: ${{ hashFiles('package.json') != '' }}
        run: npm ci

      # ---------------------------
      # Lint & Test
      # ---------------------------
      - name: Run Linter
        if: ${{ hashFiles('package.json') != '' }}
        run: npm run lint --if-present

      - name: Unit Tests
        if: ${{ hashFiles('package.json') != '' }}
        run: npm test --if-present

      # ---------------------------
      # Set CI Variables
      # ---------------------------
      - name: Set CI Variables
        id: vars
        run: |
          SHORT_SHA=${GITHUB_SHA::7}

          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            IMAGE_TAG="${GITHUB_REF_NAME}"
            ENV="prod"
          elif [[ "${GITHUB_REF_NAME}" == "develop" ]]; then
            IMAGE_TAG="dev-${SHORT_SHA}"
            ENV="develop"
          elif [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            IMAGE_TAG="uat-${SHORT_SHA}"
            ENV="uat"
          else
            echo "‚ö† Unsupported ref: ${GITHUB_REF_TYPE}/${GITHUB_REF_NAME}"
            exit 1
          fi

          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "ENV=${ENV}"         >> $GITHUB_ENV

          echo "üè∑  IMAGE_TAG = $IMAGE_TAG"
          echo "üåç ENV       = $ENV"

      # ---------------------------
      # GCP Auth (OIDC Workload Identity)
      # ---------------------------
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # ---------------------------
      # Build & Push (Multi-Arch + Cache)
      # ---------------------------
      - name: Build & Push Docker Image
        run: |
          IMAGE_URI=${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}
          echo "üî® Building & Pushing ${IMAGE_URI}"

          docker buildx create --use --name buildx || docker buildx use buildx

          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --build-arg NODE_ENV=production \
            --cache-from=type=registry,ref=${IMAGE_URI} \
            --cache-to=type=registry,ref=${IMAGE_URI},mode=max \
            -t ${IMAGE_URI} \
            . \
            --push
          
          echo "‚úÖ Build & Push completed."
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV

      # ---------------------------
      # Trivy Scan
      # ---------------------------
      - name: Trivy Scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${IMAGE_URI}
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      # ---------------------------
      # GitOps Update
      # ---------------------------
      - name: Update GitOps manifest
        if: github.ref_type == 'branch'
        run: |
          VALUES_FILE="k8s/helm/test-devops/values-${ENV}.yaml"
          [ -f "$VALUES_FILE" ] || { echo "‚ùå Missing: $VALUES_FILE"; exit 1; }

          echo "üìù Update tag to ${IMAGE_TAG} in ${VALUES_FILE}"
          sed -i "s|tag:.*|tag: ${IMAGE_TAG}|g" "$VALUES_FILE"

          git config user.email "bot@github.com"
          git config user.name  "GitHub Actions Bot"

          git add "$VALUES_FILE"
          git commit -m "GitOps: Update ${ENV} image to ${IMAGE_TAG}" || echo "‚ÑπÔ∏è No changes"
          git push
