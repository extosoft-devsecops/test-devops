name: CI Pipeline

on:
  push:
    branches: [ develop, main ]
    tags:
      - 'v*.*.*'     # Semantic Versioning

permissions:
  contents: write
  id-token: write
  security-events: write   # ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Trivy SARIF ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï

env:
  REGION: asia-southeast1
  REPO_NAME: test-devops-images
  IMAGE_NAME: test-devops

jobs:
  ci:
    # ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô GitOps loop: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô bot ‡∏ó‡∏µ‡πà push ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô‡∏ã‡πâ‡∏≥
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest

    steps:
      # ---------------------------
      # Checkout Source
      # ---------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------
      # Setup Node + Cache
      # ---------------------------
      - name: Setup Node
        if: ${{ hashFiles('package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      # ---------------------------
      # Install Dependencies
      # ---------------------------
      - name: Install Dependencies
        run: |
          if [ -f "package.json" ]; then
            npm ci
          else
            echo "No package.json found, skip npm install."
          fi

      # ---------------------------
      # Lint
      # ---------------------------
      - name: Run Linter
        run: |
          if [ -f "package.json" ]; then
            npm run lint --if-present
          else
            echo "No package.json found, skip lint."
          fi

      # ---------------------------
      # Unit Tests
      # ---------------------------
      - name: Unit Tests
        run: |
          if [ -f "package.json" ]; then
            npm test --if-present
          else
            echo "No package.json found, skip tests."
          fi

      # ---------------------------
      # Set CI Variables (IMAGE_TAG + ENV)
      # ---------------------------
      - name: Set CI Variables
        id: vars
        run: |
          SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)

          # Default
          IMAGE_TAG=""
          ENV=""

          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            # Production tags (v1.0.0 ‡∏Ø‡∏•‡∏Ø)
            IMAGE_TAG="${GITHUB_REF_NAME}"
          elif [[ "${GITHUB_REF_NAME}" == "develop" ]]; then
            IMAGE_TAG="dev-${SHORT_SHA}"
            ENV="develop"
          elif [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            IMAGE_TAG="uat-${SHORT_SHA}"
            ENV="uat"
          else
            echo "‚ö† Unsupported ref: ${GITHUB_REF_TYPE} / ${GITHUB_REF_NAME}"
          fi

          if [[ -z "$IMAGE_TAG" ]]; then
            echo "‚ùå IMAGE_TAG is empty, abort."
            exit 1
          fi

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "ENV=$ENV" >> $GITHUB_ENV

          echo "‚úÖ IMAGE_TAG = $IMAGE_TAG"
          echo "‚úÖ ENV       = $ENV"

      # ---------------------------
      # GCP Auth (Workload Identity Federation)
      # ---------------------------
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # ---------------------------
      # Build Docker Image
      # ---------------------------
      - name: Build Docker Image
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          echo "üî® Building image with tag: ${IMAGE_TAG}"
          docker build \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG} .

      # ---------------------------
      # Security Scan (Trivy)
      # ---------------------------
      - name: Trivy Image Scan
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true


      # ---------------------------
      # Verify GCP Access Token
      # ---------------------------
      - name: Verify access token
        run: |
          gcloud auth print-access-token --impersonate-service-account=${{ secrets.WIF_SERVICE_ACCOUNT }} | head

      # ---------------------------
      # Push to Artifact Registry
      # ---------------------------
      - name: Push Docker Image
        env:
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          echo "üì¶ Pushing image: ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}

      # ---------------------------
      # Update GitOps Manifests (develop/uat only)
      # ---------------------------
      - name: Update GitOps manifest
        if: github.ref_type == 'branch'
        env:
          ENV: ${{ env.ENV }}
          IMAGE_TAG: ${{ env.IMAGE_TAG }}
        run: |
          if [[ -z "$ENV" ]]; then
            echo "‚ÑπÔ∏è No ENV mapping for branch ${GITHUB_REF_NAME}, skip GitOps update."
            exit 0
          fi

          echo "Updating GitOps manifest for branch: ${GITHUB_REF_NAME}"
          echo "üöÄ GitOps target environment = ${ENV}"

          VALUES_FILE="k8s/helm/test-devops/values-${ENV}.yaml"

          if [[ ! -f "$VALUES_FILE" ]]; then
            echo "‚ùå Missing environment values file: $VALUES_FILE"
            exit 1
          fi

          echo "üìù Set image tag to ${IMAGE_TAG} in ${VALUES_FILE}"
          sed -i "s|tag:.*|tag: ${IMAGE_TAG}|g" "$VALUES_FILE"

          git config user.email "bot@github.com"
          git config user.name "GitHub Actions Bot"

          git add "$VALUES_FILE"
          git commit -m "GitOps: Update ${ENV} to image tag ${IMAGE_TAG}" || echo "‚ÑπÔ∏è No changes to commit"
          git push
