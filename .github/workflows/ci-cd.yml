name: CI & CD

on:
  pull_request:
    branches: [ develop, main ]
  push:
    branches: [ develop, main ]
    tags:
      - 'v*.*.*'

env:
  NODE_VERSION: '18.x'
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
  GAR_HOST: asia-southeast1-docker.pkg.dev
  GAR_REPOSITORY: test-devops-images
  IMAGE_NAME: test-devops
  GITOPS_REPO: extosoft-devsecops/test-devops-gitops
  GITOPS_PAT: ${{ secrets.GITOPS_PAT }}

jobs:
  ci:
    name: Init + Lint + Unit Test + Scan Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Unit Test
        run: npm run test:coverage

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=test-devops
            -Dsonar.projectName=test-devops
            -Dsonar.sources=index.js,index.test.js
            -Dsonar.sourceEncoding=UTF-8
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.exclusions=**/node_modules/**,**/coverage/**
            -Dsonar.test.inclusions=index.test.js
            -Dsonar.verbose=true

  build_and_scan_image:
    name: Build & Push Image (multi-arch) + Trivy Scan
    runs-on: ubuntu-latest
    needs: ci
    if: |
      github.event_name == 'push' &&
      (
        startsWith(github.ref, 'refs/heads/develop') ||
        startsWith(github.ref, 'refs/heads/main') ||
        startsWith(github.ref, 'refs/tags/v')
      )

    outputs:
      image_full: ${{ steps.meta.outputs.image }}
      image_name: ${{ steps.meta.outputs.image_name }}
      tag: ${{ steps.meta.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GAR_HOST }} --quiet

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set Image Tag
        id: meta
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "branch" ]]; then
            BRANCH="${GITHUB_REF_NAME}"
            TAG="${BRANCH//\//-}-${GITHUB_SHA::7}"
          else
            # tag push เช่น v1.0.0
            TAG="${GITHUB_REF_NAME}"
          fi

          IMAGE="${GAR_HOST}/${GCP_PROJECT_ID}/${GAR_REPOSITORY}/${IMAGE_NAME}:${TAG}"
          
          echo "IMAGE_FULL: ${IMAGE}"
          echo "IMAGE_NAME: ${IMAGE_NAME}"
          echo "TAG: ${TAG}"
          
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "TAG=${TAG}" >> $GITHUB_ENV           

          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "IMAGE=${IMAGE}" >> $GITHUB_ENV

      - name: Docker Build & Push (multi-arch)
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.image }}

      - name: "Trivy Image Scan"
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.meta.outputs.image }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

  deploy_gitops:
    name: Deploy (update Codefresh GitOps repo)
    runs-on: ubuntu-latest
    needs: build_and_scan_image
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main')

    env:
      IMAGE_FULL: ${{ needs.build_and_scan_image.outputs.image_full }}
      IMAGE_NAME: ${{ needs.build_and_scan_image.outputs.image_name }}
      TAG: ${{ needs.build_and_scan_image.outputs.tag }}

    steps:
      - name: Checkout GitOps repo (Codefresh runtime shared config)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          token: ${{ env.GITOPS_PAT }}
          fetch-depth: 0

      - name: Set git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine environment & manifest path (Codefresh runtime codefresh)
        id: envinfo
        run: |
          if [[ "${GITHUB_REF_NAME}" == "develop" ]]; then
            ENVIRONMENT="develop"
            MANIFEST_PATH="helm/test-devops/values-develop.yaml"
          elif [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            ENVIRONMENT="uat"
            MANIFEST_PATH="helm/test-devops/values-uat.yaml"
          else
            echo "Unknown branch for deploy"
            exit 1
          fi
          echo "env=${ENVIRONMENT}" >> $GITHUB_OUTPUT
          echo "manifest_path=${MANIFEST_PATH}" >> $GITHUB_OUTPUT

      - name: Update image tag in app manifest
        run: |
          MANIFEST="${{ steps.envinfo.outputs.manifest_path }}"
          TAG="${{ env.TAG }}"
          
          echo "Updating image tag in ${MANIFEST} to ${TAG}"
          sed -i "s/^  tag:.*/  tag: \"${TAG}\"/g" "${MANIFEST}"

      - name: Commit & push
        id: commit
        run: |
          git status
          if ! git diff --quiet; then
            git add .
            git commit -m "chore: deploy ${{ steps.envinfo.outputs.env }} with image ${{ env.IMAGE_FULL }}"
            git push
            echo "result=Changes committed and pushed on gitops repo" >> $GITHUB_OUTPUT
          else
            echo "result=No changes to commit" >> $GITHUB_OUTPUT
          fi

  security_scan:
    name: Security Scan (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: deploy_gitops
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main')
    steps:
      - name: Set target URL
        id: url
        run: |
          case "${GITHUB_REF_NAME}" in
            develop)
              echo "target=https://test-devops-dev.extosoft.app" >> $GITHUB_OUTPUT
              ;;
            main)
              echo "target=https://test-devops-uat.extosoft.app/" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "Unknown branch for ZAP target"
              exit 1
              ;;
          esac
      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ steps.url.outputs.target }}
          rules_file_name: ''
          cmd_options: '-a -J zap-report.json'
        continue-on-error: true
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap-report.json
      - name: Fail if critical/high found
        run: |
          if grep -q '"risk": "High"' zap-report.json || grep -q '"risk": "Critical"' zap-report.json; then
            echo "Critical/High vulnerabilities found!"
            exit 1
          fi
